resolver        127.0.0.11 valid=10s;       # docker resolver is at 127.0.0.11

#server {
#  listen    80 default_server;
#  deny all;
#  location / {
#    satisfy any;
#    auth_basic "Restricted access";
#    auth_basic_user_file /etc/nginx/basic_auth;
#    proxy_pass        http://localhost:8081;
#    proxy_set_header    Host            $host;
#    proxy_set_header    X-Forwarded-For $remote_addr;
#  }
#}

#server {
#  listen    443 ssl default_server;
#  ssl_certificate    /etc/letsencrypt/live/test.chatmatic.com/fullchain.pem;
#  ssl_certificate_key    /etc/letsencrypt/live/test.chatmatic.com/privkey.pem;
#  deny all;
#  location / {
#    satisfy any;
#    auth_basic "Restricted access";
#    auth_basic_user_file /etc/nginx/basic_auth;
#    proxy_pass          http://localhost:8081;
#    proxy_set_header    Host            $host;
#    proxy_set_header    X-Forwarded-For $remote_addr;
#  }
#}

server {
    listen              80;
    server_name         internal.chatmatic.info;
    # allow               10.15.1.82;
    # allow        127.0.0.1;
    # deny all;
    root /var/www/html;
    index index.html;
    set     $dest "pipeline";
    location /broadcast {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /messenger-code {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /sdk-response {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /count-broadcast {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /zapier {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /update-subscribers {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
    location /workflow-json {
            # include uwsgi_params;
            # uwsgi_pass unix:///run/uwsgi/chatmatic.sock;
            proxy_pass http://$dest:9000;
    }
}

# admin.*, api.*
server {
    listen              80;
    server_name	        admin admin.* api api.*;
    location /.well-known {
        include         conf.d/proxy_params;
        set             $dest "letsencrypt";
        proxy_pass      http://$dest:80;
    }
    location / {
        include         conf.d/proxy_params;
        set             $dest "laravel";
        proxy_pass      http://$dest;
    }
}
server {
    listen              443 ssl;
    server_name	        admin admin.* api api.* links links.*;
    include             /etc/letsencrypt/nginx_ssl_directives.inc;
    client_max_body_size 60m;
    location / {
        include         conf.d/proxy_params;
        set             $dest "laravel";
        proxy_pass      http://$dest;
    }
}

# app.*
server {
    listen              80;
    server_name	        app app.*;
    location /.well-known {
        include         conf.d/proxy_params;
        set             $dest "letsencrypt";
        proxy_pass      http://$dest:80;
    }
    location / {
        rewrite         .* https://$host$uri permanent;
        #include         conf.d/proxy_params;
        #set             $dest "react";
        #proxy_pass      http://$dest;
    }
}
server {
    listen              443 ssl;
    server_name         app app.*;
    include		/etc/letsencrypt/nginx_ssl_directives.inc;
    location / {
        include         conf.d/proxy_params;
        set             $dest "react";
        proxy_pass      http://$dest;
    }
}

# default server
server {
    listen              80 default_server;
    server_name         staging.chatdeploy.com;
    include             /etc/nginx/conf.d/chatmatic-common.inc;
}
server {
    listen              443 ssl default_server;
    server_name         live.chatmatic.com staging.chatdeploy.com;
    include             /etc/letsencrypt/nginx_ssl_directives.inc;
    include             /etc/nginx/conf.d/chatmatic-common.inc;
}
